# ระบบป้องกันการทำแบบทดสอบซ้ำ

## ภาพรวม
ระบบนี้ถูกออกแบบมาเพื่อป้องกันไม่ให้ผู้ใช้ทำแบบทดสอบที่ผ่านไปแล้วซ้ำ โดยจะแสดงเฉพาะเนื้อหาบทเรียนและคะแนนที่ได้แทนปุ่มทำแบบทดสอบ

## คุณสมบัติหลัก

### 1. การป้องกันการทำแบบทดสอบซ้ำ
- เมื่อผู้ใช้เข้าด่านที่ทำสำเร็จไปแล้ว ระบบจะแสดงเฉพาะเนื้อหาบทเรียน
- ไม่มีปุ่ม "ทำแบบทดสอบ" สำหรับด่านที่ผ่านแล้ว
- แสดงคะแนนที่ได้ในด่านนั้นแทน

### 2. การแสดงผลสำหรับด่านที่ทำสำเร็จแล้ว
- แสดงข้อความ "ด่านนี้ทำสำเร็จแล้ว!"
- แสดงคะแนนที่ได้ (เช่น "คะแนน: 8/10")
- ใช้สีเขียวเพื่อแสดงสถานะสำเร็จ
- มีปุ่ม "กลับ" เพื่อกลับไปหน้าก่อน

### 3. ระบบรีเซ็ต
- เพิ่มปุ่มรีเซ็ต (ไอคอน refresh) ในแถบด้านบนของหน้าแผนที่บทเรียน
- รีเซ็ตจะลบความคืบหน้าและคะแนนทั้งหมดของบทเรียนนั้น
- หลังจากรีเซ็ต ผู้ใช้สามารถทำแบบทดสอบใหม่ได้

### 4. ปุ่มนำทาง
- เพิ่มปุ่มกลับ (ไอคอนลูกศร) ในแถบบนของหน้าแสดงเนื้อหาบทเรียน
- มีปุ่ม "กลับ" ในส่วนล่างสำหรับทั้งด่านที่ทำสำเร็จแล้วและด่านที่ยังไม่ทำ
- ปุ่ม "กลับ" จะนำผู้ใช้กลับไปยังหน้าแผนที่บทเรียน

## การทำงานของระบบ

### การตรวจสอบสถานะด่าน
```dart
// ตรวจสอบว่าด่านนั้นทำสำเร็จแล้วหรือยัง
final isCompleted = await ProgressService.I.isStageCompleted(
  uid: user.uid,
  subject: subject,
  lesson: lesson,
  stage: stage,
);
```

### การแสดงเนื้อหาสำหรับด่านที่ทำสำเร็จแล้ว
```dart
// ถ้าด่านนี้ทำสำเร็จแล้ว ให้แสดงเฉพาะเนื้อหา
if (isCompleted) {
  if (!_hide) {
    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => LessonWordPage(
          subject: _subject,
          lesson: widget.lesson,
          stage: stage,
          wordDocId: '${_subject}_${widget.lesson}_$stage',
        ),
      ),
    );
  }
  return; // ไม่ต้องทำแบบทดสอบซ้ำ
}
```

### การรีเซ็ตความคืบหน้า
```dart
// รีเซ็ตความคืบหน้าของบทเรียน
await ProgressService.I.resetLessonProgress(
  uid: user.uid,
  subject: _subject,
  lesson: widget.lesson,
);
```

## ไฟล์ที่ถูกแก้ไข

### 1. `lib/services/progress_service.dart`
- เพิ่มฟังก์ชัน `resetStageProgress()` สำหรับรีเซ็ตด่านเดียว
- เพิ่มฟังก์ชัน `isStageCompleted()` สำหรับตรวจสอบสถานะด่าน

### 2. `lib/subject/lesson_word.dart`
- เพิ่มการตรวจสอบสถานะด่าน
- แสดงคะแนนแทนปุ่มทำแบบทดสอบสำหรับด่านที่ทำสำเร็จแล้ว
- เพิ่มฟังก์ชัน `_buildCompletedStageButton()` และ `_buildQuizButton()`

### 3. `lib/subject/computer_lesson_map_page.dart`
- แก้ไขฟังก์ชัน `_openStage()` เพื่อไม่ให้เข้าทำแบบทดสอบซ้ำ
- เพิ่มปุ่มรีเซ็ตในแถบด้านบน
- เพิ่มฟังก์ชัน `_showResetDialog()` และ `_resetProgress()`

### 4. `lib/subject/electronics_lesson_map_page.dart`
- แก้ไขฟังก์ชัน `_openStage()` เพื่อไม่ให้เข้าทำแบบทดสอบซ้ำ
- เพิ่มปุ่มรีเซ็ตในแถบด้านบน
- เพิ่มฟังก์ชัน `_showResetDialog()` และ `_resetProgress()`

## การใช้งาน

### สำหรับผู้ใช้
1. **เข้าด่านที่ยังไม่ทำ**: จะเห็นเนื้อหาบทเรียน ปุ่ม "กลับ" และปุ่ม "ไปหน้าคำถาม!!"
2. **เข้าด่านที่ทำสำเร็จแล้ว**: จะเห็นเนื้อหาบทเรียน ปุ่ม "กลับ" และคะแนนที่ได้
3. **รีเซ็ตความคืบหน้า**: กดปุ่มรีเซ็ต (ไอคอน refresh) ในแถบด้านบน
4. **กลับไปหน้าก่อน**: กดปุ่ม "กลับ" หรือไอคอนลูกศรในแถบบน

### สำหรับนักพัฒนา
1. ระบบใช้ `ProgressService.I.isStageCompleted()` เพื่อตรวจสอบสถานะด่าน
2. ใช้ `ProgressService.I.resetLessonProgress()` เพื่อรีเซ็ตความคืบหน้า
3. ใช้ `ProgressService.I.getStageScore()` เพื่อดึงคะแนนของด่าน

## ข้อควรระวัง
- การรีเซ็ตจะลบความคืบหน้าและคะแนนทั้งหมดของบทเรียนนั้น
- ไม่สามารถกู้คืนข้อมูลที่ถูกลบได้
- ควรแจ้งเตือนผู้ใช้ก่อนการรีเซ็ต

## การทดสอบ
1. ทำแบบทดสอบให้ผ่านด่านใดด่านหนึ่ง
2. เข้าด่านนั้นอีกครั้ง ควรเห็นคะแนนแทนปุ่มทำแบบทดสอบ
3. กดปุ่มรีเซ็ต ควรเห็นความคืบหน้ารีเซ็ต
4. เข้าด่านนั้นอีกครั้ง ควรเห็นปุ่มทำแบบทดสอบอีกครั้ง
